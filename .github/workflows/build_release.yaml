# This action uploads the newly built artifacts as a GitHub release.
# Then creating the Cloudflare pages site with redirects to the new release files.

on:
    workflow_call: {}
permissions: {}
jobs:
    release:
        name: Release
        runs-on: ubuntu-24.04
        steps:
            - uses: actions/checkout@v4

            - uses: actions/download-artifact@v4
              with:
                  name: win-x64 # .zip from build_windows
                  repository: element-hq/element-desktop
                  run-id: 13567591786

            - name: Get app version
              run: |
                  echo "version=$(cat package.json | jq -r .version)" >> $GITHUB_ENV

            - name: Extract files
              run: |
                  unzip -q win-x64.zip -d ./artifacts
                  ls -la ./artifacts/squirrel-windows

            - name: Create release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: v${{ env.VERSION }}
                  name: v${{ env.VERSION }}
                  draft: false
                  prerelease: false
                  files: |
                      ./artifacts/extracted/squirrel-windows/Element Setup ${{ env.VERSION }}.exe
                      ./artifacts/extracted/squirrel-windows/Element-desktop-${{ env.VERSION }}-full.nupkg
                      ./artifacts/extracted/squirrel-windows/RELEASES
                  body: "[See the full elecord changelog](https://github.com/elecordapp/elecord-web/releases/tag/v${{ env.VERSION }})"
              # env:
              #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
